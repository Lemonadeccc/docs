# Generator过程

## 创建 package.json

### 初始化配置文件基本内容

控制台输出蓝色提示人员键入信息，生成 `package.json` 文件。
定义包含了基本的配置例如项目名称、版本、是否私有、开发依赖和脚本等字段 `packageContent` 信息的对象，并进行了初始化。
根据构建工具类型进行不同的操作。类型为 `webpack` 则复制整个目录到目标目录。如果复制成功输出完成信息。如果复制错误，则捕获错误并输出错误。


### 初始化构建工具配置文件

首先从 `buildTool.config.ejs` 中读取读取并返回文件内容,获取 `ejs` 格式的原始配置文件，其次借助 `ejs.render` 根据所选模板、构建工具等信息对 `ejs`  格式文件进行渲染。对解析出来的文件生成初始 `ast` 语法树，用于后续合并配置并生成真实的构建工具配置文件。目前 `create-neat` 项目使用`babel/parser`包进行解析。根据构建工具类型选取不同的命令行语句为 `package.json` 生成不同的 `scripts` 脚本。


### 插入插件依赖

根据所选 `plugins` 中的依赖版本号进行处理，若没有版本号则选取最新版本号。并将插件以开发环境依赖安装。特殊地，团队为 `babel` 插件集成了适用于项目的插件包，在使用过程中会使用`babel-plugin-test-ljq`包代替。然后根据项目的根路径创建可创建 `package.json` 文件的 `PackageAPI` 实例。其实例收集所有需创目录后异步创建所有目录，并行写入所有文件。
然后初始化 `Git` 仓库。若目前为生产环境的话根据所创建 `package.json` 安装所有生产依赖以及开发依赖。


## Generator生成

控制台提示生成信息辅助使用者明确脚手架开始构建。
脚手架根据根路径、插件、包内容、模板及选项配置对象创建 `Generator` 类，并根据额外配置文件调用 `generate` 方法进行生成。
类创建过程中，创建所有 `plugin` 和 `template` 的相关文件。由于不同插件之间对 `ts` 环境要求的配置不同，故需判断是否具备 `ts` 开发环境。为每个 `plugin` 创建 `GeneratorAPI` 实例，调用插件中的 `generate` 方法。在处理单个插件时，根据环境变量加载 `plugin` ，若加载结果为函数则执行。将框架需要的依赖添加到 `package.json` 中，以及如果该框架如果需要添加构建工具配置属性，则借助 `ast` 进行添加。根据 `template` 路径创建文件树实例，并使用 `ejs` 将文件树渲染到指定目录下形成文件。 此部分跳转[文件树生成](file-tree-processing.md)部分。





## 构建工具配置文件生成

构建工具配置文件生成，将由构建工具配置的 `ast` 转换为代码，并写入至构建工具配置文件中。
`package.json` 额外文件生成，重写 `package.json` 文件，并向根文件树中添加该文件，消除 `generatorAPI` 中拓展 `package.json` 带来得副作用。创建目录及文件并安装 `package.json` 。


## 安装附加依赖
根据 `package.json` 安装开发依赖及生产依赖。

## 其他剩余操作

创建 `md` 文档，添加 `.gitignore` 文件，记录结束时间并计算打印输出构建时间及其他内容。